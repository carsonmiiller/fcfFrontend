{"version":3,"file":"useFilter.js","sources":["../../../src/table/hooks/useFilter.tsx"],"sourcesContent":["import React, { useEffect, useState, MutableRefObject } from 'react';\nimport useClassName from './useClassName';\nimport TButton from '../../button';\nimport { TdPrimaryTableProps, PrimaryTableCol, TableRowData, FilterValue } from '../type';\nimport useControlled from '../../hooks/useControlled';\nimport TableFilterController from '../FilterController';\nimport { useLocaleReceiver } from '../../locale/LocalReceiver';\n\n// 筛选条件不为空，才需要显示筛选结果行\nfunction filterEmptyData(data: FilterValue) {\n  const newFilterValue: FilterValue = {};\n  Object.keys(data).forEach((key) => {\n    const item = data[key];\n    const isArrayTrue = item instanceof Array && item.length;\n    const isObject = typeof item === 'object' && !(item instanceof Array);\n    const isObjectTrue = isObject && Object.keys(item).length;\n    if (isArrayTrue || isObjectTrue || !['null', '', 'undefined'].includes(String(item))) {\n      newFilterValue[key] = item;\n    }\n  });\n  return newFilterValue;\n}\n\nexport default function useFilter(props: TdPrimaryTableProps, primaryTableRef: MutableRefObject<any>) {\n  const [locale, t] = useLocaleReceiver('table');\n  const { tableFilterClasses, isFocusClass } = useClassName();\n  const [isTableOverflowHidden, setIsTableOverflowHidden] = useState<boolean>();\n\n  // unControl and control\n  const [tFilterValue, setTFilterValue] = useControlled(props, 'filterValue', props.onFilterChange);\n\n  // 过滤内部值\n  const [innerFilterValue, setInnerFilterValue] = useState<FilterValue>(tFilterValue);\n\n  const hasEmptyCondition = (() => {\n    const filterEmpty = filterEmptyData(tFilterValue || {});\n    return !tFilterValue || !Object.keys(filterEmpty).length;\n  })();\n\n  useEffect(() => {\n    setInnerFilterValue(tFilterValue);\n  }, [tFilterValue]);\n\n  function renderFirstFilterRow() {\n    if (hasEmptyCondition) return null;\n    const defaultNode = (\n      <div className={tableFilterClasses.result}>\n        <span>\n          {/* 搜索 “{getFilterResultContent()}”， */}\n          {/* 找到 {props.pagination?.total || props.data?.length} 条结果 */}\n          {t(locale.searchResultText, {\n            result: getFilterResultContent(),\n            count: props.pagination?.total || props.data?.length,\n          })}\n        </span>\n        <TButton theme=\"primary\" variant=\"text\" onClick={onResetAll}>\n          {locale.clearFilterResultButtonText}\n        </TButton>\n      </div>\n    );\n    const filterContent = props.filterRow;\n    if (props.filterRow && !filterContent) return null;\n    const r = filterContent || defaultNode;\n    if (!r) return null;\n    return <div className={tableFilterClasses.inner}>{r}</div>;\n  }\n\n  // 获取搜索条件内容，存在 options 需要获取其 label 显示\n  function getFilterResultContent(): string {\n    const arr: string[] = [];\n    props.columns\n      .filter((col) => col.filter)\n      .forEach((col) => {\n        let value = tFilterValue[col.colKey];\n        if (col.filter.list && !['null', '', 'undefined'].includes(String(value))) {\n          const formattedValue = value instanceof Array ? value : [value];\n          const label: string[] = [];\n          col.filter.list.forEach((option) => {\n            if (formattedValue.includes(option.value)) {\n              label.push(option.label);\n            }\n          });\n          value = label.join();\n        }\n        if (value) {\n          arr.push(`${col.title}：${value}`);\n        }\n      });\n    return arr.join('；');\n  }\n\n  function onInnerFilterChange(val: any, column: PrimaryTableCol) {\n    const filterValue = {\n      ...innerFilterValue,\n      [column.colKey]: val,\n    };\n    setInnerFilterValue(filterValue);\n    if (!column.filter.showConfirmAndReset) {\n      emitFilterChange(filterValue, column);\n    }\n  }\n\n  function emitFilterChange(filterValue: FilterValue, column?: PrimaryTableCol) {\n    setTFilterValue(filterValue, { col: column });\n    props.onChange?.({ filter: filterValue }, { trigger: 'filter' });\n  }\n\n  function onReset(column: PrimaryTableCol) {\n    const filterValue: FilterValue = {\n      ...tFilterValue,\n      [column.colKey]:\n        {\n          single: '',\n          multiple: [],\n          input: '',\n        }[column.filter.type] ||\n        column.filter.resetValue ||\n        '',\n    };\n    emitFilterChange(filterValue, column);\n  }\n\n  function onResetAll() {\n    emitFilterChange({}, undefined);\n  }\n\n  function onConfirm(column: PrimaryTableCol) {\n    emitFilterChange(innerFilterValue, column);\n  }\n\n  // 图标：内置图标，组件自定义图标，全局配置图标\n  function renderFilterIcon({ col }: { col: PrimaryTableCol<TableRowData>; colIndex: number }) {\n    return (\n      <TableFilterController\n        column={col}\n        filterIcon={props.filterIcon}\n        tFilterValue={tFilterValue}\n        innerFilterValue={innerFilterValue}\n        tableFilterClasses={tableFilterClasses}\n        isFocusClass={isFocusClass}\n        onReset={onReset}\n        onConfirm={onConfirm}\n        onInnerFilterChange={onInnerFilterChange}\n        primaryTableElement={primaryTableRef?.current?.tableElement}\n        onVisibleChange={onPopupVisibleChange}\n      ></TableFilterController>\n    );\n  }\n\n  function onPopupVisibleChange(visible: boolean) {\n    if (visible && !isTableOverflowHidden) {\n      setIsTableOverflowHidden(!visible);\n    }\n  }\n\n  return {\n    hasEmptyCondition,\n    isTableOverflowHidden,\n    renderFilterIcon,\n    renderFirstFilterRow,\n  };\n}\n"],"names":["filterEmptyData","data","newFilterValue","Object","keys","forEach","key","item","isArrayTrue","Array","length","isObject","_typeof","isObjectTrue","includes","String","useFilter","props","primaryTableRef","useLocaleReceiver","_slicedToArray","locale","t","useClassName","tableFilterClasses","isFocusClass","useState","isTableOverflowHidden","setIsTableOverflowHidden","useControlled","onFilterChange","tFilterValue","setTFilterValue","innerFilterValue","setInnerFilterValue","hasEmptyCondition","filterEmpty","useEffect","renderFirstFilterRow","defaultNode","React","createElement","className","result","searchResultText","getFilterResultContent","count","pagination","total","TButton","theme","variant","onClick","onResetAll","clearFilterResultButtonText","filterContent","filterRow","r","inner","arr","columns","filter","col","value","colKey","list","formattedValue","label","option","push","join","title","onInnerFilterChange","val","column","filterValue","_defineProperty","showConfirmAndReset","emitFilterChange","onChange","trigger","onReset","single","multiple","input","type","resetValue","onConfirm","renderFilterIcon","TableFilterController","filterIcon","primaryTableElement","current","tableElement","onVisibleChange","onPopupVisibleChange","visible"],"mappings":"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"}