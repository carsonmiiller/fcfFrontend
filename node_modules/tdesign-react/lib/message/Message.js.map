{"version":3,"file":"Message.js","sources":["../../src/message/Message.tsx"],"sourcesContent":["import React from 'react';\nimport ReactDOM from 'react-dom';\nimport classNames from 'classnames';\n\nimport {\n  MessageCloseAllMethod,\n  MessageErrorMethod,\n  MessageInfoMethod,\n  MessageInstance,\n  MessageLoadingMethod,\n  MessageMethod,\n  MessageOptions,\n  MessageQuestionMethod,\n  MessageSuccessMethod,\n  MessageWarningMethod,\n  MessageThemeList,\n} from './type';\nimport { AttachNodeReturnValue } from '../common';\nimport noop from '../_util/noop';\nimport { PlacementOffset } from './const';\nimport MessageComponent from './MessageComponent';\n\n// 定义全局的 message 列表，closeAll 函数需要使用\nlet MessageList: MessageInstance[] = [];\nlet keyIndex = 1;\n\n// 全局默认配置，zIndex 为 5000，默认关闭事件 3000\nconst globalConfig = {\n  zIndex: 5000,\n  duration: 3000,\n  top: 32,\n};\n\nexport interface MessagePlugin {\n  (theme: MessageThemeList, message: string | MessageOptions, duration?: number): Promise<MessageInstance>;\n  info: MessageInfoMethod;\n  success: MessageSuccessMethod;\n  warning: MessageWarningMethod;\n  error: MessageErrorMethod;\n  question: MessageQuestionMethod;\n  loading: MessageLoadingMethod;\n  closeAll: MessageCloseAllMethod;\n  close: (message: Promise<MessageInstance>) => void;\n}\n\n/**\n * @author kenzyyang\n * @date 2021-05-11 20:36:52\n * @desc 创建容器，所有的 message 会填充到容器中\n */\nfunction createContainer({ attach, zIndex, placement = 'top' }: MessageOptions) {\n  // 默认注入到 body 中，如果用户有制定，以用户指定的为准\n  let mountedDom: AttachNodeReturnValue = document.body;\n\n  // attach 为字符串时认为是选择器\n  if (typeof attach === 'string') {\n    const result = document.querySelectorAll(attach);\n    if (result.length >= 1) {\n      // :todo 编译器提示 nodelist 为类数组类型，并没有实现迭代器，没办法使用数组解构，暂时加上 eslint-disable\n      // eslint-disable-next-line prefer-destructuring\n      mountedDom = result[0];\n    }\n  } else if (typeof attach === 'function') {\n    mountedDom = attach();\n  }\n\n  // :todo 暂时写死，需要 pmc 确定如何在非组件中拿到动态配置的样式前缀\n  const tdMessageListClass = 't-message__list';\n  const tdMessagePlacementClass = `t-message-placement--${placement}`;\n\n  // 选择器找到一个挂载 message 的容器，不存在则创建\n  const container = Array.from(mountedDom.querySelectorAll(`.${tdMessageListClass}.${tdMessagePlacementClass}`));\n  if (container.length < 1) {\n    const div = document.createElement('div');\n    div.className = classNames(tdMessageListClass, tdMessagePlacementClass);\n    div.style.zIndex = String(zIndex || globalConfig.zIndex);\n\n    Object.keys(PlacementOffset[placement]).forEach((key) => {\n      div.style[key] = PlacementOffset[placement][key];\n    });\n\n    if (placement.includes('top')) {\n      div.style.top = `${globalConfig.top}px`;\n    }\n    mountedDom.appendChild(div);\n    return div;\n  }\n  return container[0];\n}\n\n/**\n * @desc 函数式调用时的 message 渲染函数\n */\nfunction renderElement(theme, config: MessageOptions): Promise<MessageInstance> {\n  const container = createContainer(config) as HTMLElement;\n  let { duration = globalConfig.duration } = config;\n  const { content, offset, onDurationEnd = noop } = config;\n  const div = document.createElement('div');\n\n  keyIndex += 1;\n\n  const message = {\n    close: () => {\n      ReactDOM.unmountComponentAtNode(div);\n      div.remove();\n    },\n    key: keyIndex,\n  };\n\n  // 校验duration 合法性\n  if (duration < 0) {\n    duration = 3000;\n  }\n  if (duration !== 0) {\n    setTimeout(() => {\n      message.close();\n      onDurationEnd();\n    }, duration);\n  }\n\n  let style: React.CSSProperties = {};\n  if (Array.isArray(offset) && offset.length === 2) {\n    const [left, top] = offset;\n    style = {\n      left,\n      top,\n      position: 'relative',\n    };\n  }\n\n  return new Promise((resolve) => {\n    // 渲染组件\n    ReactDOM.render(\n      <MessageComponent theme={theme} style={style} key={keyIndex} {...config}>\n        {content}\n      </MessageComponent>,\n      div,\n    );\n\n    // 将当前渲染的 message 挂载到指定的容器中\n    container.appendChild(div);\n    // message 推入 message 列表\n    MessageList.push(message);\n    // 将 message 实例通过 resolve 返回给 promise 调用方\n    resolve(message);\n  });\n}\n\n// 判断是否是 messageOptions\nfunction isConfig(content: MessageOptions | React.ReactNode): content is MessageOptions {\n  return Object.prototype.toString.call(content) === '[object Object]' && !!(content as MessageOptions).content;\n}\n\nconst messageMethod: MessageMethod = (theme: MessageThemeList, content, duration: number = globalConfig.duration) => {\n  let config = {} as MessageOptions;\n  if (isConfig(content)) {\n    config = {\n      duration,\n      ...content,\n    };\n  } else {\n    config = {\n      content,\n      duration,\n    };\n  }\n  config = {\n    ...config,\n    zIndex: config.zIndex || globalConfig.zIndex,\n  };\n  return renderElement(theme, config);\n};\n\nexport const MessagePlugin: MessagePlugin = (theme, message, duration) => messageMethod(theme, message, duration);\nMessagePlugin.info = (content, duration) => messageMethod('info', content, duration);\nMessagePlugin.error = (content, duration) => messageMethod('error', content, duration);\nMessagePlugin.warning = (content, duration) => messageMethod('warning', content, duration);\nMessagePlugin.success = (content, duration) => messageMethod('success', content, duration);\nMessagePlugin.question = (content, duration) => messageMethod('question', content, duration);\nMessagePlugin.loading = (content, duration) => messageMethod('loading', content, duration);\n\n/**\n * @date 2021-05-16 13:11:24\n * @desc Message 顶层内置函数，传入 message promise，关闭传入的 message.\n */\nMessagePlugin.close = (messageInstance) => {\n  messageInstance.then((instance) => instance.close());\n};\n\n/**\n * @date 2021-05-16 13:11:24\n * @desc 关闭所有的 message\n * :todo 需明确关闭范围，目前 message 中暂无 namespace 类似概念，暂时做全 message 关闭\n * 可预见到的扩展: 根据不同的 attach 做关闭,根据不同的类型做关闭，根据不同的 namespace 做关闭等等\n */\nMessagePlugin.closeAll = (): MessageCloseAllMethod => {\n  MessageList.forEach((message) => {\n    typeof message.close === 'function' && message.close();\n  });\n  MessageList = [];\n  return;\n};\n\nexport default MessageComponent;\n"],"names":["MessageList","keyIndex","globalConfig","zIndex","duration","top","createContainer","attach","placement","mountedDom","document","body","result","querySelectorAll","length","tdMessageListClass","tdMessagePlacementClass","container","Array","from","div","createElement","className","classNames","style","String","Object","keys","PlacementOffset","forEach","key","includes","appendChild","renderElement","theme","config","content","offset","onDurationEnd","noop","message","close","ReactDOM","unmountComponentAtNode","remove","setTimeout","isArray","_slicedToArray","left","position","Promise","resolve","render","React","MessageComponent","push","isConfig","prototype","toString","call","messageMethod","MessagePlugin","info","error","warning","success","question","loading","messageInstance","then","instance","closeAll"],"mappings":"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"}