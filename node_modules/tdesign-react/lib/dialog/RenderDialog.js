/**
 * tdesign v0.34.4
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var defineProperty = require('../_chunks/dep-a1655de1.js');
var React = require('react');
var reactTransitionGroup = require('react-transition-group');
var classNames = require('classnames');
var common_Portal = require('../common/Portal.js');
var _util_noop = require('../_util/noop.js');
var _util_useLayoutEffect = require('../_util/useLayoutEffect.js');
var _util_useDialogEsc = require('../_util/useDialogEsc.js');
var dialog_defaultProps = require('./defaultProps.js');
require('../_chunks/dep-3405bda4.js');
require('react-dom');
require('../_util/dom.js');
require('raf');
require('../_chunks/dep-1d819290.js');
require('../_chunks/dep-fcf32c81.js');
require('../_chunks/dep-c90cc28f.js');
require('../_chunks/dep-b1a67107.js');
require('../_util/easing.js');
require('../_util/useConfig.js');
require('../_chunks/dep-38a46f48.js');
require('../_chunks/dep-8a149e9f.js');
require('../_chunks/dep-3b69722d.js');
require('../_chunks/dep-fde4d28a.js');
require('../_chunks/dep-e266830c.js');
require('../_chunks/dep-15a4424e.js');
require('../_chunks/dep-c40d75ac.js');
require('../_chunks/dep-910dcfa3.js');
require('../_chunks/dep-633a5671.js');
require('../_chunks/dep-9c339ffc.js');
require('../_chunks/dep-ab43c961.js');
require('../_chunks/dep-9cacaf01.js');
require('../_chunks/dep-c72c7229.js');
require('../_chunks/dep-8e0a771d.js');
require('../_chunks/dep-542cc308.js');
require('../_chunks/dep-c6637e11.js');
require('../_common/js/global-config/locale/zh_CN.js');
require('../config-provider/zh_CN_config.js');
require('../_chunks/dep-f6a4bdd5.js');
require('../_chunks/dep-19841e1d.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { defineProperty._defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

var transitionTime = 300;
var mousePosition;

var getClickPosition = function getClickPosition(e) {
  mousePosition = {
    x: e.clientX,
    y: e.clientY
  };
  setTimeout(function () {
    mousePosition = null;
  }, 100);
};

if (typeof window !== "undefined" && window.document && window.document.documentElement) {
  document.documentElement.addEventListener("click", getClickPosition, true);
}

var RenderDialog = /*#__PURE__*/React.forwardRef(function (props, ref) {
  var prefixCls = props.prefixCls,
      attach = props.attach,
      visible = props.visible,
      mode = props.mode,
      zIndex = props.zIndex,
      showOverlay = props.showOverlay,
      _props$onEscKeydown = props.onEscKeydown,
      onEscKeydown = _props$onEscKeydown === void 0 ? _util_noop["default"] : _props$onEscKeydown,
      _props$onClosed = props.onClosed,
      onClosed = _props$onClosed === void 0 ? _util_noop["default"] : _props$onClosed,
      _props$onClose = props.onClose,
      onClose = _props$onClose === void 0 ? _util_noop["default"] : _props$onClose,
      _props$onCloseBtnClic = props.onCloseBtnClick,
      onCloseBtnClick = _props$onCloseBtnClic === void 0 ? _util_noop["default"] : _props$onCloseBtnClic,
      _props$onOverlayClick = props.onOverlayClick,
      onOverlayClick = _props$onOverlayClick === void 0 ? _util_noop["default"] : _props$onOverlayClick,
      preventScrollThrough = props.preventScrollThrough,
      closeBtn = props.closeBtn,
      closeOnEscKeydown = props.closeOnEscKeydown,
      closeOnOverlayClick = props.closeOnOverlayClick,
      destroyOnClose = props.destroyOnClose;
  var wrap = React.useRef();
  var dialog = React.useRef();
  var maskRef = React.useRef();
  var portalRef = React.useRef();
  var bodyOverflow = React.useRef();
  var bodyCssTextRef = React.useRef();
  var isModal = mode === "modal";
  var canDraggable = props.draggable && mode === "modeless";
  var dialogOpenClass = "".concat(prefixCls, "__open");
  _util_useDialogEsc["default"](visible, wrap);
  React.useImperativeHandle(ref, function () {
    return wrap.current;
  });
  _util_useLayoutEffect["default"](function () {
    bodyOverflow.current = document.body.style.overflow;
    bodyCssTextRef.current = document.body.style.cssText;
  }, []);
  _util_useLayoutEffect["default"](function () {
    if (visible) {
      if (isModal && bodyOverflow.current !== "hidden" && preventScrollThrough) {
        var scrollWidth = window.innerWidth - document.body.offsetWidth;

        if (bodyCssTextRef.current === "") {
          var bodyCssText = "overflow: hidden;";

          if (scrollWidth > 0) {
            bodyCssText += "position: relative;width: calc(100% - ".concat(scrollWidth, "px);");
          }

          document.body.style.cssText = bodyCssText;
        } else {
          if (scrollWidth > 0) {
            document.body.style.width = "calc(100% - ".concat(scrollWidth, "px)");
            document.body.style.position = "relative";
          }

          document.body.style.overflow = "hidden";
        }
      }

      if (wrap.current) {
        wrap.current.focus();
      }
    } else if (isModal) {
      var openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

      if (openDialogDom.length < 1) {
        document.body.style.cssText = bodyCssTextRef.current;
      }
    }

    return function () {
      if (isModal) {
        var _openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

        if (_openDialogDom.length < 1) {
          document.body.style.cssText = bodyCssTextRef.current;
          document.body.style.overflow = bodyOverflow.current;
        }
      } else {
        document.body.style.cssText = bodyCssTextRef.current;
        document.body.style.overflow = bodyOverflow.current;
      }
    };
  }, [preventScrollThrough, attach, visible, mode, isModal, dialogOpenClass]);
  React.useEffect(function () {
    if (visible) {
      if (mousePosition && dialog.current) {
        dialog.current.style.transformOrigin = "".concat(mousePosition.x - dialog.current.offsetLeft, "px ").concat(mousePosition.y - dialog.current.offsetTop, "px");
      }
    }
  }, [visible]);

  var onAnimateLeave = function onAnimateLeave() {
    if (wrap.current) {
      wrap.current.style.display = "none";
    }

    if (isModal && preventScrollThrough) {
      var openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

      if (isModal && openDialogDom.length < 1) {
        document.body.style.overflow = bodyOverflow.current;
      }
    }

    if (!isModal) {
      var style = dialog.current.style;
      style.left = "50%";
      style.top = "50%";
    }

    onClosed && onClosed();
  };

  var onMaskClick = function onMaskClick(e) {
    if (e.target === e.currentTarget && closeOnOverlayClick) {
      onOverlayClick({
        e: e
      });
      onClose({
        e: e,
        trigger: "overlay"
      });
    }
  };

  var handleCloseBtnClick = function handleCloseBtnClick(e) {
    onCloseBtnClick({
      e: e
    });
    onClose({
      e: e,
      trigger: "close-btn"
    });
  };

  var handleKeyDown = function handleKeyDown(e) {
    if (+e.code === 27
    /* ESC */
    || e.keyCode === 27
    /* ESC */
    ) {
      e.stopPropagation();
      onEscKeydown({
        e: e
      });

      if (closeOnEscKeydown) {
        onClose({
          e: e,
          trigger: "esc"
        });
      }
    }
  };

  var renderDialog = function renderDialog(classNames) {
    var dest = {};

    if (props.width !== void 0) {
      dest.width = props.width;
    }

    var footer = props.footer ? /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(prefixCls, "__footer")
    }, props.footer) : null;
    var header = props.header;
    var body = /* @__PURE__ */React__default["default"].createElement("div", {
      className: "".concat(prefixCls, "__body")
    }, props.body || props.children);
    var closer = closeBtn && /* @__PURE__ */React__default["default"].createElement("span", {
      onClick: handleCloseBtnClick,
      className: "".concat(prefixCls, "__close")
    }, closeBtn);

    var style = _objectSpread(_objectSpread({}, dest), props.style);

    var dialogOffset = {
      x: 0,
      y: 0
    };

    var onDialogMove = function onDialogMove(e) {
      var _dialog$current = dialog.current,
          style2 = _dialog$current.style,
          offsetWidth = _dialog$current.offsetWidth,
          offsetHeight = _dialog$current.offsetHeight,
          clientHeight = _dialog$current.clientHeight,
          clientWidth = _dialog$current.clientWidth;
      var halfHeight = clientHeight / 2;
      var halfWidth = clientWidth / 2;
      var diffX = e.clientX - dialogOffset.x;
      var diffY = e.clientY - dialogOffset.y;

      if (diffX < halfWidth) {
        diffX = halfWidth;
      }

      if (diffX > window.innerWidth - offsetWidth + halfWidth) {
        diffX = window.innerWidth - offsetWidth + halfWidth;
      }

      if (diffY < halfHeight) {
        diffY = halfHeight;
      }

      if (diffY > window.innerHeight - offsetHeight + halfHeight) {
        diffY = window.innerHeight - offsetHeight + halfHeight;
      }

      style2.left = "".concat(diffX, "px");
      style2.top = "".concat(diffY, "px");
    };

    var onDialogMoveEnd = function onDialogMoveEnd() {
      dialog.current.style.cursor = "default";
      document.removeEventListener("mousemove", onDialogMove);
      document.removeEventListener("mouseup", onDialogMoveEnd);
    };

    var onDialogMoveStart = function onDialogMoveStart(e) {
      if (canDraggable) {
        var _dialog$current2 = dialog.current,
            offsetLeft = _dialog$current2.offsetLeft,
            offsetTop = _dialog$current2.offsetTop;
        dialog.current.style.cursor = "move";
        var diffX = e.clientX - offsetLeft;
        var diffY = e.clientY - offsetTop;
        dialogOffset = {
          x: diffX,
          y: diffY
        };
        document.addEventListener("mousemove", onDialogMove);
        document.addEventListener("mouseup", onDialogMoveEnd);
      }
    };

    var dialogElement = /* @__PURE__ */React__default["default"].createElement("div", {
      ref: dialog,
      style: style,
      className: classNames__default["default"]("".concat(prefixCls), "".concat(prefixCls, "--default"), classNames),
      onMouseDown: onDialogMoveStart
    }, closer, header, body, footer);
    return /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, {
      "in": props.visible,
      appear: true,
      mountOnEnter: true,
      unmountOnExit: destroyOnClose,
      timeout: transitionTime,
      classNames: "".concat(prefixCls, "-zoom"),
      onEntered: props.onOpened,
      onExited: onAnimateLeave,
      nodeRef: dialog
    }, dialogElement);
  };

  var renderMask = function renderMask() {
    var maskElement;

    if (showOverlay) {
      maskElement = /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, {
        "in": visible,
        appear: true,
        timeout: transitionTime,
        classNames: "".concat(prefixCls, "-fade"),
        mountOnEnter: true,
        unmountOnExit: true,
        nodeRef: maskRef
      }, /* @__PURE__ */React__default["default"].createElement("div", {
        ref: maskRef,
        onClick: onMaskClick,
        className: "".concat(prefixCls, "__mask")
      }));
    }

    return maskElement;
  };

  var render = function render() {
    var style = {};

    if (visible) {
      style.display = "block";
    }

    var wrapStyle = _objectSpread(_objectSpread({}, style), {}, {
      zIndex: zIndex
    });

    var dialogBody = renderDialog("".concat(props.placement ? "".concat(prefixCls, "--").concat(props.placement) : ""));
    var wrapClass = classNames__default["default"](props.className, "".concat(prefixCls, "__ctx"), "".concat(prefixCls, "__ctx--fixed"), visible ? dialogOpenClass : "");
    var dialog2 = /* @__PURE__ */React__default["default"].createElement("div", {
      ref: wrap,
      className: wrapClass,
      style: wrapStyle,
      onKeyDown: handleKeyDown,
      tabIndex: 0
    }, mode === "modal" && renderMask(), dialogBody);
    var dom = null;

    if (visible || wrap.current) {
      if (!attach) {
        dom = dialog2;
      } else {
        dom = /* @__PURE__ */React__default["default"].createElement(reactTransitionGroup.CSSTransition, {
          "in": visible,
          appear: true,
          timeout: transitionTime,
          mountOnEnter: true,
          unmountOnExit: destroyOnClose,
          nodeRef: portalRef
        }, /* @__PURE__ */React__default["default"].createElement(common_Portal["default"], {
          attach: attach,
          ref: portalRef
        }, dialog2));
      }
    }

    return dom;
  };

  return render();
});
RenderDialog.defaultProps = dialog_defaultProps.dialogDefaultProps;

exports["default"] = RenderDialog;
//# sourceMappingURL=RenderDialog.js.map
