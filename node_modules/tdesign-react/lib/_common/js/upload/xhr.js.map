{"version":3,"file":"xhr.js","sources":["../../../../src/_common/js/upload/xhr.ts"],"sourcesContent":["import { UploadFile, XhrOptions } from './types';\n\nexport default function xhr({\n  method = 'POST',\n  action,\n  withCredentials = false,\n  headers = {},\n  data = {},\n  file,\n  files,\n  name = 'file',\n  onError,\n  onProgress,\n  onSuccess,\n}: XhrOptions) {\n  // support files\n  const innerFiles: UploadFile[] = files || [];\n\n  // eslint-disable-next-line no-shadow\n  const xhr = new XMLHttpRequest();\n  if (withCredentials) {\n    xhr.withCredentials = true;\n  }\n\n  // set send data\n  const formData = new FormData();\n  const sendData = typeof data === 'function' ? data(file) : data;\n  Object.keys(sendData).forEach((key) => {\n    formData.append(key, data[key]);\n  });\n\n  // support one request upload multiple files\n  innerFiles.forEach((f) => {\n    formData.append(name, f && f.raw as any);\n  });\n\n  xhr.open(method, action, true);\n\n  // custom request headers\n  Object.keys(headers).forEach((key) => {\n    xhr.setRequestHeader(key, headers[key]);\n  });\n\n  xhr.onerror = (event: ProgressEvent) => onError({ event, file, files: innerFiles });\n\n  if (xhr.upload) {\n    xhr.upload.onprogress = (event: ProgressEvent) => {\n      let percent = 0;\n      if (event.total > 0) {\n        percent = Math.round((event.loaded / event.total) * 100);\n      }\n\n      onProgress({\n        event, percent, file, files: innerFiles\n      });\n    };\n  }\n\n  // eslint-disable-next-line consistent-return\n  xhr.onload = (event: ProgressEvent) => {\n    let response;\n    const isFail = xhr.status < 200 || xhr.status >= 300;\n    if (isFail) {\n      return onError({\n        event, file, files: innerFiles, response\n      });\n    }\n    const text = xhr.responseText || xhr.response;\n    try {\n      response = JSON.parse(text);\n    } catch (e) {\n      response = text;\n    }\n    onSuccess({\n      event, file, files: innerFiles, response\n    });\n  };\n\n  xhr.send(formData);\n\n  return xhr;\n}\n"],"names":["xhr","method","action","withCredentials","headers","data","file","files","name","onError","onProgress","onSuccess","innerFiles","xhr2","XMLHttpRequest","formData","FormData","sendData","Object","keys","forEach","key","append","f","raw","open","setRequestHeader","onerror","event","upload","onprogress","percent","total","Math","round","loaded","onload","response","isFail","status","text","responseText","JSON","parse","e","send"],"mappings":";;;;;;;;;;AAAe,SAASA,GAAT,CAYZ,IAAA,EAAA;AAAA,EAAA,IAAA,WAAA,GAAA,IAAA,CAXDC,MAWC;MAXDA,MAWC,4BAXQ,MAWR,GAAA,WAAA;MAVDC,MAUC,QAVDA,MAUC;AAAA,MAAA,oBAAA,GAAA,IAAA,CATDC,eASC;MATDA,eASC,qCATiB,KASjB,GAAA,oBAAA;AAAA,MAAA,YAAA,GAAA,IAAA,CARDC,OAQC;MARDA,OAQC,6BARS,EAQT,GAAA,YAAA;AAAA,MAAA,SAAA,GAAA,IAAA,CAPDC,IAOC;MAPDA,IAOC,0BAPM,EAON,GAAA,SAAA;MANDC,IAMC,QANDA,IAMC;MALDC,KAKC,QALDA,KAKC;AAAA,MAAA,SAAA,GAAA,IAAA,CAJDC,IAIC;MAJDA,IAIC,0BAJM,MAIN,GAAA,SAAA;MAHDC,OAGC,QAHDA,OAGC;MAFDC,UAEC,QAFDA,UAEC;MADDC,SACC,QADDA,SACC,CAAA;AACD,EAAA,IAAMC,UAAU,GAAGL,KAAK,IAAI,EAA5B,CAAA;AACA,EAAA,IAAMM,IAAI,GAAG,IAAIC,cAAJ,EAAb,CAAA;;AACA,EAAA,IAAIX,eAAJ,EAAqB;IACnBU,IAAI,CAACV,eAAL,GAAuB,IAAvB,CAAA;AACD,GAAA;;AACD,EAAA,IAAMY,QAAQ,GAAG,IAAIC,QAAJ,EAAjB,CAAA;AACA,EAAA,IAAMC,QAAQ,GAAG,OAAOZ,IAAP,KAAgB,UAAhB,GAA6BA,IAAI,CAACC,IAAD,CAAjC,GAA0CD,IAA3D,CAAA;EACAa,MAAM,CAACC,IAAP,CAAYF,QAAZ,EAAsBG,OAAtB,CAA8B,UAACC,GAAD,EAAS;IACrCN,QAAQ,CAACO,MAAT,CAAgBD,GAAhB,EAAqBhB,IAAI,CAACgB,GAAD,CAAzB,CAAA,CAAA;GADF,CAAA,CAAA;AAGAT,EAAAA,UAAU,CAACQ,OAAX,CAAmB,UAACG,CAAD,EAAO;IACxBR,QAAQ,CAACO,MAAT,CAAgBd,IAAhB,EAAsBe,CAAC,IAAIA,CAAC,CAACC,GAA7B,CAAA,CAAA;GADF,CAAA,CAAA;AAGAX,EAAAA,IAAI,CAACY,IAAL,CAAUxB,MAAV,EAAkBC,MAAlB,EAA0B,IAA1B,CAAA,CAAA;EACAgB,MAAM,CAACC,IAAP,CAAYf,OAAZ,EAAqBgB,OAArB,CAA6B,UAACC,GAAD,EAAS;IACpCR,IAAI,CAACa,gBAAL,CAAsBL,GAAtB,EAA2BjB,OAAO,CAACiB,GAAD,CAAlC,CAAA,CAAA;GADF,CAAA,CAAA;;AAGAR,EAAAA,IAAI,CAACc,OAAL,GAAe,UAACC,KAAD,EAAA;AAAA,IAAA,OAAWnB,OAAO,CAAC;AAAEmB,MAAAA,KAAK,EAALA,KAAF;AAAStB,MAAAA,IAAI,EAAJA,IAAT;AAAeC,MAAAA,KAAK,EAAEK,UAAAA;AAAtB,KAAD,CAAlB,CAAA;GAAf,CAAA;;EACA,IAAIC,IAAI,CAACgB,MAAT,EAAiB;AACfhB,IAAAA,IAAI,CAACgB,MAAL,CAAYC,UAAZ,GAAyB,UAACF,KAAD,EAAW;MAClC,IAAIG,OAAO,GAAG,CAAd,CAAA;;AACA,MAAA,IAAIH,KAAK,CAACI,KAAN,GAAc,CAAlB,EAAqB;AACnBD,QAAAA,OAAO,GAAGE,IAAI,CAACC,KAAL,CAAWN,KAAK,CAACO,MAAN,GAAeP,KAAK,CAACI,KAArB,GAA6B,GAAxC,CAAV,CAAA;AACD,OAAA;;AACDtB,MAAAA,UAAU,CAAC;AACTkB,QAAAA,KAAK,EAALA,KADS;AAETG,QAAAA,OAAO,EAAPA,OAFS;AAGTzB,QAAAA,IAAI,EAAJA,IAHS;AAITC,QAAAA,KAAK,EAAEK,UAAAA;AAJE,OAAD,CAAV,CAAA;KALF,CAAA;AAYD,GAAA;;AACDC,EAAAA,IAAI,CAACuB,MAAL,GAAc,UAACR,KAAD,EAAW;AACvB,IAAA,IAAIS,QAAJ,CAAA;AACA,IAAA,IAAMC,MAAM,GAAGzB,IAAI,CAAC0B,MAAL,GAAc,GAAd,IAAqB1B,IAAI,CAAC0B,MAAL,IAAe,GAAnD,CAAA;;AACA,IAAA,IAAID,MAAJ,EAAY;AACV,MAAA,OAAO7B,OAAO,CAAC;AACbmB,QAAAA,KAAK,EAALA,KADa;AAEbtB,QAAAA,IAAI,EAAJA,IAFa;AAGbC,QAAAA,KAAK,EAAEK,UAHM;AAIbyB,QAAAA,QAAQ,EAARA,QAAAA;AAJa,OAAD,CAAd,CAAA;AAMD,KAAA;;IACD,IAAMG,IAAI,GAAG3B,IAAI,CAAC4B,YAAL,IAAqB5B,IAAI,CAACwB,QAAvC,CAAA;;IACA,IAAI;AACFA,MAAAA,QAAQ,GAAGK,IAAI,CAACC,KAAL,CAAWH,IAAX,CAAX,CAAA;KADF,CAEE,OAAOI,CAAP,EAAU;AACVP,MAAAA,QAAQ,GAAGG,IAAX,CAAA;AACD,KAAA;;AACD7B,IAAAA,SAAS,CAAC;AACRiB,MAAAA,KAAK,EAALA,KADQ;AAERtB,MAAAA,IAAI,EAAJA,IAFQ;AAGRC,MAAAA,KAAK,EAAEK,UAHC;AAIRyB,MAAAA,QAAQ,EAARA,QAAAA;AAJQ,KAAD,CAAT,CAAA;GAjBF,CAAA;;EAwBAxB,IAAI,CAACgC,IAAL,CAAU9B,QAAV,CAAA,CAAA;AACA,EAAA,OAAOF,IAAP,CAAA;AACD;;;;"}