{"version":3,"file":"useSorter.js","sources":["../../../src/table/hooks/useSorter.tsx"],"sourcesContent":["import React, { useState, MouseEvent } from 'react';\nimport isFunction from 'lodash/isFunction';\nimport { SortInfo, TdPrimaryTableProps, PrimaryTableCol, TableRowData } from '../type';\nimport SorterButton from '../SorterButton';\nimport useControlled from '../../hooks/useControlled';\n\nexport type SortMap = Record<string, SortInfo & { index: number }>;\n\nexport default function useSorter(props: TdPrimaryTableProps) {\n  const [originalData, setOriginalData] = useState<TableRowData[]>();\n  const [tSortInfo, setTSortInfo] = useControlled(props, 'sort', props.onSortChange);\n  const [tData, setTData] = useControlled(props, 'data', props.onDataChange);\n  // 本地数据排序：用于记录哪些字段是自定义排序函数\n  const sorterFuncMap = getSorterFuncMap(props.columns);\n\n  const sortArray = (() => {\n    const sort = tSortInfo;\n    if (!sort) return [];\n    return Array.isArray(sort) ? sort : [sort];\n  })();\n\n  const sortMap = (() => {\n    const sortMap = {};\n    sortArray.forEach((info, index) => {\n      const { sortBy } = info;\n      sortMap[sortBy] = { index, ...info };\n    });\n    return sortMap;\n  })();\n\n  function getSorterFuncMap(columns: PrimaryTableCol[], map: { [key: string]: Function } = {}) {\n    for (let i = 0, len = columns.length; i < len; i++) {\n      const col = columns[i];\n      if (isFunction(col.sorter)) {\n        // eslint-disable-next-line no-param-reassign\n        map[col.colKey] = col.sorter;\n      }\n      // 多级表头中的排序功能\n      if (col.children?.length) {\n        getSorterFuncMap(col.children, map);\n      }\n    }\n    return map;\n  }\n\n  function handleDataSort(sortInfo: SortInfo | Array<SortInfo>) {\n    const sort = sortInfo;\n    if (!sorterFuncMap || !Object.keys(sorterFuncMap).length) return;\n    if (!originalData) {\n      setOriginalData(tData);\n    }\n    const isEmptyArraySort = !sort || (sort instanceof Array && !sort.length);\n    const isEmptyObjectSort = !(sort instanceof Array) && !sort?.sortBy;\n    if (isEmptyArraySort || isEmptyObjectSort) {\n      setTData(originalData, { trigger: 'sort' });\n      return originalData;\n    }\n    const formattedSort = sort instanceof Array ? sort : [sort];\n    // data 为受控属性，data.slice() 浅拷贝，防止 sort 导致原数据变异\n    const newData: TableRowData[] = tData.slice().sort((a: TableRowData, b: TableRowData) => {\n      let sortResult = 0;\n      for (let i = 0, len = formattedSort.length; i < len; i++) {\n        const item = formattedSort[i];\n        const sortFunc = sorterFuncMap[item.sortBy];\n        // 上一个排序字段值相同时才会进行下一个字段的大小对比\n        if (sortResult === 0 && sortFunc) {\n          sortResult = item.descending ? sortFunc(b, a) : sortFunc(a, b);\n        } else {\n          break;\n        }\n      }\n      return sortResult;\n    });\n    // Data 变化返回的是数据引用，为避免死循环，特此检测排序数据前后是否相同，如果相同则不再触发事件\n    if (JSON.stringify(newData) === JSON.stringify(tData)) return;\n    setTData(newData, { trigger: 'sort' });\n    return newData;\n  }\n\n  function handleSortHeaderClick(col: PrimaryTableCol<TableRowData>, p: { descending: boolean }) {\n    let sortInfo: SortInfo | Array<SortInfo>;\n    if (props.multipleSort) {\n      sortInfo = getMultipleNextSort(col, p);\n    } else {\n      const sort = tSortInfo instanceof Array ? tSortInfo[0] : tSortInfo;\n      sortInfo = getSingleNextSort(col, sort, p);\n    }\n    // 本地数据 data 排序，需同时抛出 data-change\n    const newData = handleDataSort(sortInfo);\n    const currentData = newData || tData;\n    const currentDataSource = currentData;\n    setTSortInfo(sortInfo, { currentDataSource, col });\n    props.onChange?.({ sorter: sortInfo }, { currentData, trigger: 'sorter' });\n  }\n\n  function getSortOrder(descending: boolean) {\n    if (descending === undefined) return;\n    return descending ? 'desc' : 'asc';\n  }\n\n  // 点击新排序字段，则默认按照降序排序；点击原字段，则排序字段不变仅切换排序方式\n  function getSingleNextSort(col: PrimaryTableCol, sortInfo: SortInfo, p: { descending: boolean }): SortInfo {\n    // 排序字段和排序方式均相同，则取消排序\n    if (sortInfo && sortInfo.sortBy === col.colKey && sortInfo.descending === p.descending) {\n      return undefined;\n    }\n    return { sortBy: col.colKey, descending: p.descending };\n  }\n\n  function getMultipleNextSort(col: PrimaryTableCol<TableRowData>, p: { descending: boolean }): Array<SortInfo> {\n    const sort = tSortInfo;\n    if (!(sort instanceof Array)) return;\n    const { colKey } = col;\n    const result = [...sort];\n    for (let i = 0, len = sort.length; i < len; i++) {\n      if (sort[i].sortBy === colKey) {\n        const next = getSingleNextSort(col, sort[i], p);\n        next ? (result[i] = next) : result.splice(i, 1);\n        return result;\n      }\n    }\n    result.push({ sortBy: colKey, descending: p.descending });\n    return result;\n  }\n\n  function renderSortIcon({ col }: { col: PrimaryTableCol<TableRowData>; colIndex: number }) {\n    if (!col.sorter) return null;\n    const sorterButtonsProps = {\n      sortType: col.sortType,\n      sortOrder: getSortOrder(sortMap[col.colKey]?.descending),\n      sortIcon: props.sortIcon,\n    };\n    return (\n      <SorterButton\n        key={`sorter-button-${col.colKey}`}\n        {...sorterButtonsProps}\n        onSortIconClick={(_: MouseEvent<HTMLSpanElement>, p: { descending: boolean }) => handleSortHeaderClick(col, p)}\n      />\n    );\n  }\n\n  return {\n    renderSortIcon,\n  };\n}\n"],"names":["useSorter","props","useState","originalData","setOriginalData","useControlled","onSortChange","tSortInfo","setTSortInfo","onDataChange","tData","setTData","sorterFuncMap","getSorterFuncMap","columns","sortArray","sort","Array","isArray","sortMap","sortMap2","forEach","info","index","sortBy","map","i","len","length","col","isFunction","sorter","colKey","children","handleDataSort","sortInfo","Object","keys","isEmptyArraySort","isEmptyObjectSort","trigger","formattedSort","newData","slice","a","b","sortResult","item","sortFunc","descending","JSON","stringify","handleSortHeaderClick","p","multipleSort","getMultipleNextSort","getSingleNextSort","currentData","currentDataSource","onChange","getSortOrder","result","next","splice","push","renderSortIcon","sorterButtonsProps","sortType","sortOrder","sortIcon","React","createElement","SorterButton","key","onSortIconClick","_"],"mappings":"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"}