{"version":3,"file":"Anchor.js","sources":["../../src/anchor/Anchor.tsx"],"sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport classNames from 'classnames';\nimport isEmpty from 'lodash/isEmpty';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps } from '../common';\nimport { TdAnchorProps } from './type';\nimport useConfig from '../_util/useConfig';\nimport { canUseDocument, getScrollContainer } from '../_util/dom';\nimport Affix from '../affix';\nimport { AnchorContext, Item } from './AnchorContext';\nimport { getOffsetTop, getScroll, scrollTo, AnchorContainer } from './_util/dom';\nimport AnchorItem from './AnchorItem';\nimport AnchorTarget from './AnchorTarget';\nimport { anchorDefaultProps } from './defaultProps';\n\nexport interface AnchorProps extends TdAnchorProps, StyledProps {\n  children?: React.ReactNode;\n}\n\ninterface IntervalRef {\n  // 收集 anchor-item\n  items: string[];\n  // 容器\n  scrollContainer: AnchorContainer;\n  // 收集各项 item 的信息与节点\n  handleScrollLock: boolean;\n}\n\nconst ANCHOR_SHARP_REGEXP = /#(\\S+)$/;\n\nconst Anchor = (props: AnchorProps) => {\n  const { affixProps, bounds, targetOffset, container, size, children, cursor, onClick, onChange, className, ...rest } =\n    props;\n\n  const { classPrefix } = useConfig();\n\n  const [activeItem, setActiveItem] = useState<string>('');\n  const [cursorStyle, setCursorStyle] = useState<{ top: string; height?: string; opacity: number }>({\n    top: '0px',\n    height: '0px',\n    opacity: 0,\n  });\n\n  const anchorEl = useRef(null);\n  const intervalRef = useRef<IntervalRef>({\n    items: [],\n    scrollContainer: canUseDocument ? window : null,\n    handleScrollLock: false,\n  });\n\n  /**\n   * 注册锚点\n   * @param href 链接\n   */\n  const registerItem = (href: string): void => {\n    const { items } = intervalRef.current;\n    if (ANCHOR_SHARP_REGEXP.test(href) && items.indexOf(href) < 0) items.push(href);\n  };\n\n  const unregisterItem = (href: string): void => {\n    const { items } = intervalRef.current;\n    intervalRef.current.items = items.filter((item) => href !== item);\n  };\n\n  const getAnchorTarget = (href: string): HTMLElement => document.querySelector(href);\n\n  const handleScrollTo = (link: string) => {\n    const anchor = getAnchorTarget(link);\n    if (!anchor) return;\n    onChange?.(link, activeItem);\n    setActiveItem(link);\n    intervalRef.current.handleScrollLock = true;\n    const { scrollContainer } = intervalRef.current;\n    const scrollTop = getScroll(scrollContainer);\n    const offsetTop = getOffsetTop(anchor, scrollContainer);\n    const top = scrollTop + offsetTop - targetOffset;\n    scrollTo(top, {\n      container: scrollContainer,\n    }).then(() => {\n      intervalRef.current.handleScrollLock = false;\n    });\n  };\n\n  const handleClick = (item: Item, e: React.MouseEvent<HTMLDivElement>) => {\n    onClick?.({ e, ...item });\n    handleScrollTo(item.href);\n  };\n\n  useEffect(() => {\n    // update point style\n    const pointEl = anchorEl.current.querySelector(`.${classPrefix}-is-active>a`) as HTMLAnchorElement;\n    if (!pointEl) {\n      setCursorStyle(null);\n    } else {\n      const { offsetTop: top, offsetHeight: height } = pointEl;\n      setCursorStyle({ top: `${top}px`, height: `${height}px`, opacity: 1 });\n    }\n  }, [activeItem, classPrefix]);\n\n  const handleScroll = useCallback(() => {\n    const { scrollContainer, handleScrollLock } = intervalRef.current;\n    if (handleScrollLock) return;\n    const { items } = intervalRef.current;\n    const filters: { top: number; href: string }[] = [];\n    let active = '';\n    // 找出所有当前top小于预设值\n    items.forEach((href) => {\n      const anchor = getAnchorTarget(href);\n      if (!anchor) return;\n      const top = getOffsetTop(anchor, scrollContainer);\n      if (top <= bounds + targetOffset) {\n        filters.push({\n          href,\n          top,\n        });\n      }\n    });\n\n    // 找出小于预设值集合中top最大的\n    if (filters.length) {\n      const latest = filters.reduce((prev, cur) => (prev.top > cur.top ? prev : cur));\n      active = latest.href;\n    }\n    if (active !== activeItem) {\n      onChange?.(active, activeItem);\n      setActiveItem(active);\n    }\n  }, [activeItem, bounds, onChange, targetOffset]);\n\n  useEffect(() => {\n    intervalRef.current.scrollContainer = getScrollContainer(container);\n    const { scrollContainer } = intervalRef.current;\n\n    handleScroll();\n    scrollContainer.addEventListener('scroll', handleScroll);\n    return () => {\n      scrollContainer.removeEventListener('scroll', handleScroll);\n    };\n  }, [container, handleScroll]);\n\n  const anchorClass = classNames(\n    `${classPrefix}-anchor`,\n    {\n      [`${classPrefix}-size-s`]: size === 'small',\n      [`${classPrefix}-size-m`]: size === 'medium',\n      [`${classPrefix}-size-l`]: size === 'large',\n    },\n    className,\n  );\n\n  const CursorCmp = () => {\n    if (isFunction(cursor)) return cursor();\n    if (isEmpty(cursor)) return <div className={`${classPrefix}-anchor__line-cursor`}></div>;\n    return cursor;\n  };\n\n  const Cmp = (\n    <AnchorContext.Provider\n      value={{\n        onClick: handleClick,\n        activeItem,\n        registerItem,\n        unregisterItem,\n      }}\n    >\n      <div {...rest} className={anchorClass} ref={anchorEl}>\n        <div className={`${classPrefix}-anchor__line`}>\n          <div className={`${classPrefix}-anchor__line-cursor-wrapper`} style={cursorStyle}>\n            {CursorCmp()}\n          </div>\n        </div>\n        {children}\n      </div>\n    </AnchorContext.Provider>\n  );\n\n  return isEmpty(affixProps) ? Cmp : <Affix {...affixProps}>{Cmp}</Affix>;\n};\n\nAnchor.AnchorItem = AnchorItem;\nAnchor.AnchorTarget = AnchorTarget;\n\nAnchor.displayName = 'Anchor';\nAnchor.defaultProps = anchorDefaultProps;\n\nexport default Anchor;\n"],"names":["ANCHOR_SHARP_REGEXP","Anchor","props","affixProps","bounds","targetOffset","container","size","children","cursor","onClick","onChange","className","rest","useConfig","classPrefix","useState","activeItem","setActiveItem","top","height","opacity","cursorStyle","setCursorStyle","anchorEl","useRef","intervalRef","items","scrollContainer","canUseDocument","window","handleScrollLock","registerItem","href","current","test","indexOf","push","unregisterItem","filter","item","getAnchorTarget","document","querySelector","handleScrollTo","link","anchor","scrollTop","getScroll","offsetTop","getOffsetTop","scrollTo","then","handleClick","e","useEffect","pointEl","offsetHeight","handleScroll","useCallback","filters","active","forEach","length","latest","reduce","prev","cur","getScrollContainer","addEventListener","removeEventListener","anchorClass","classNames","CursorCmp","isFunction","isEmpty","React","createElement","Cmp","AnchorContext","Provider","value","ref","style","Affix","AnchorItem","AnchorTarget","displayName","defaultProps","anchorDefaultProps"],"mappings":"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"}