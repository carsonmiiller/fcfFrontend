/**
 * tdesign v0.34.4
 * (c) 2022 tdesign
 * @license MIT
 */

import { _ as _defineProperty } from '../_chunks/dep-08260abc.js';
import React, { forwardRef, useRef, useImperativeHandle, useEffect } from 'react';
import { CSSTransition } from 'react-transition-group';
import classNames from 'classnames';
import Portal from '../common/Portal.js';
import noop from '../_util/noop.js';
import useIsomorphicLayoutEffect from '../_util/useLayoutEffect.js';
import useDialogEsc from '../_util/useDialogEsc.js';
import { dialogDefaultProps } from './defaultProps.js';
import '../_chunks/dep-4705ff31.js';
import 'react-dom';
import '../_util/dom.js';
import 'raf';
import '../_chunks/dep-60c49e74.js';
import '../_chunks/dep-12690e1d.js';
import '../_chunks/dep-21baa91f.js';
import '../_chunks/dep-a1fd625f.js';
import '../_chunks/dep-12718f01.js';
import '../_util/easing.js';
import '../_util/useConfig.js';
import '../_chunks/dep-e3ed7551.js';
import '../_chunks/dep-ac0cc4dd.js';
import '../_chunks/dep-e3ab6b0d.js';
import '../_chunks/dep-cc4f2bae.js';
import '../_chunks/dep-531703d1.js';
import '../_chunks/dep-38424935.js';
import '../_chunks/dep-ad150068.js';
import '../_chunks/dep-d5f141ac.js';
import '../_chunks/dep-1b27e5c2.js';
import '../_chunks/dep-6963df41.js';
import '../_chunks/dep-8fb1642c.js';
import '../_chunks/dep-bcb59ae2.js';
import '../_chunks/dep-09c318fb.js';
import '../_chunks/dep-048c506f.js';
import '../_chunks/dep-febf8cf9.js';
import '../_chunks/dep-074143e4.js';
import '../_chunks/dep-f5ab8a5c.js';
import '../_chunks/dep-67009882.js';
import '../locale/zh_CN.js';
import '../_common/js/global-config/locale/zh_CN.js';
import '../config-provider/zh_CN_config.js';
import '../_chunks/dep-bd2639ad.js';
import '../_chunks/dep-0e5be0b2.js';

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

var KeyCode = /* @__PURE__ */function (KeyCode2) {
  KeyCode2[KeyCode2["ESC"] = 27] = "ESC";
  return KeyCode2;
}(KeyCode || {});

var transitionTime = 300;
var mousePosition;

var getClickPosition = function getClickPosition(e) {
  mousePosition = {
    x: e.clientX,
    y: e.clientY
  };
  setTimeout(function () {
    mousePosition = null;
  }, 100);
};

if (typeof window !== "undefined" && window.document && window.document.documentElement) {
  document.documentElement.addEventListener("click", getClickPosition, true);
}

var RenderDialog = /*#__PURE__*/forwardRef(function (props, ref) {
  var prefixCls = props.prefixCls,
      attach = props.attach,
      visible = props.visible,
      mode = props.mode,
      zIndex = props.zIndex,
      showOverlay = props.showOverlay,
      _props$onEscKeydown = props.onEscKeydown,
      onEscKeydown = _props$onEscKeydown === void 0 ? noop : _props$onEscKeydown,
      _props$onClosed = props.onClosed,
      onClosed = _props$onClosed === void 0 ? noop : _props$onClosed,
      _props$onClose = props.onClose,
      onClose = _props$onClose === void 0 ? noop : _props$onClose,
      _props$onCloseBtnClic = props.onCloseBtnClick,
      onCloseBtnClick = _props$onCloseBtnClic === void 0 ? noop : _props$onCloseBtnClic,
      _props$onOverlayClick = props.onOverlayClick,
      onOverlayClick = _props$onOverlayClick === void 0 ? noop : _props$onOverlayClick,
      preventScrollThrough = props.preventScrollThrough,
      closeBtn = props.closeBtn,
      closeOnEscKeydown = props.closeOnEscKeydown,
      closeOnOverlayClick = props.closeOnOverlayClick,
      destroyOnClose = props.destroyOnClose;
  var wrap = useRef();
  var dialog = useRef();
  var maskRef = useRef();
  var portalRef = useRef();
  var bodyOverflow = useRef();
  var bodyCssTextRef = useRef();
  var isModal = mode === "modal";
  var canDraggable = props.draggable && mode === "modeless";
  var dialogOpenClass = "".concat(prefixCls, "__open");
  useDialogEsc(visible, wrap);
  useImperativeHandle(ref, function () {
    return wrap.current;
  });
  useIsomorphicLayoutEffect(function () {
    bodyOverflow.current = document.body.style.overflow;
    bodyCssTextRef.current = document.body.style.cssText;
  }, []);
  useIsomorphicLayoutEffect(function () {
    if (visible) {
      if (isModal && bodyOverflow.current !== "hidden" && preventScrollThrough) {
        var scrollWidth = window.innerWidth - document.body.offsetWidth;

        if (bodyCssTextRef.current === "") {
          var bodyCssText = "overflow: hidden;";

          if (scrollWidth > 0) {
            bodyCssText += "position: relative;width: calc(100% - ".concat(scrollWidth, "px);");
          }

          document.body.style.cssText = bodyCssText;
        } else {
          if (scrollWidth > 0) {
            document.body.style.width = "calc(100% - ".concat(scrollWidth, "px)");
            document.body.style.position = "relative";
          }

          document.body.style.overflow = "hidden";
        }
      }

      if (wrap.current) {
        wrap.current.focus();
      }
    } else if (isModal) {
      var openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

      if (openDialogDom.length < 1) {
        document.body.style.cssText = bodyCssTextRef.current;
      }
    }

    return function () {
      if (isModal) {
        var _openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

        if (_openDialogDom.length < 1) {
          document.body.style.cssText = bodyCssTextRef.current;
          document.body.style.overflow = bodyOverflow.current;
        }
      } else {
        document.body.style.cssText = bodyCssTextRef.current;
        document.body.style.overflow = bodyOverflow.current;
      }
    };
  }, [preventScrollThrough, attach, visible, mode, isModal, dialogOpenClass]);
  useEffect(function () {
    if (visible) {
      if (mousePosition && dialog.current) {
        dialog.current.style.transformOrigin = "".concat(mousePosition.x - dialog.current.offsetLeft, "px ").concat(mousePosition.y - dialog.current.offsetTop, "px");
      }
    }
  }, [visible]);

  var onAnimateLeave = function onAnimateLeave() {
    if (wrap.current) {
      wrap.current.style.display = "none";
    }

    if (isModal && preventScrollThrough) {
      var openDialogDom = document.querySelectorAll(".".concat(dialogOpenClass));

      if (isModal && openDialogDom.length < 1) {
        document.body.style.overflow = bodyOverflow.current;
      }
    }

    if (!isModal) {
      var style = dialog.current.style;
      style.left = "50%";
      style.top = "50%";
    }

    onClosed && onClosed();
  };

  var onMaskClick = function onMaskClick(e) {
    if (e.target === e.currentTarget && closeOnOverlayClick) {
      onOverlayClick({
        e: e
      });
      onClose({
        e: e,
        trigger: "overlay"
      });
    }
  };

  var handleCloseBtnClick = function handleCloseBtnClick(e) {
    onCloseBtnClick({
      e: e
    });
    onClose({
      e: e,
      trigger: "close-btn"
    });
  };

  var handleKeyDown = function handleKeyDown(e) {
    if (+e.code === 27
    /* ESC */
    || e.keyCode === 27
    /* ESC */
    ) {
      e.stopPropagation();
      onEscKeydown({
        e: e
      });

      if (closeOnEscKeydown) {
        onClose({
          e: e,
          trigger: "esc"
        });
      }
    }
  };

  var renderDialog = function renderDialog(classNames$1) {
    var dest = {};

    if (props.width !== void 0) {
      dest.width = props.width;
    }

    var footer = props.footer ? /* @__PURE__ */React.createElement("div", {
      className: "".concat(prefixCls, "__footer")
    }, props.footer) : null;
    var header = props.header;
    var body = /* @__PURE__ */React.createElement("div", {
      className: "".concat(prefixCls, "__body")
    }, props.body || props.children);
    var closer = closeBtn && /* @__PURE__ */React.createElement("span", {
      onClick: handleCloseBtnClick,
      className: "".concat(prefixCls, "__close")
    }, closeBtn);

    var style = _objectSpread(_objectSpread({}, dest), props.style);

    var dialogOffset = {
      x: 0,
      y: 0
    };

    var onDialogMove = function onDialogMove(e) {
      var _dialog$current = dialog.current,
          style2 = _dialog$current.style,
          offsetWidth = _dialog$current.offsetWidth,
          offsetHeight = _dialog$current.offsetHeight,
          clientHeight = _dialog$current.clientHeight,
          clientWidth = _dialog$current.clientWidth;
      var halfHeight = clientHeight / 2;
      var halfWidth = clientWidth / 2;
      var diffX = e.clientX - dialogOffset.x;
      var diffY = e.clientY - dialogOffset.y;

      if (diffX < halfWidth) {
        diffX = halfWidth;
      }

      if (diffX > window.innerWidth - offsetWidth + halfWidth) {
        diffX = window.innerWidth - offsetWidth + halfWidth;
      }

      if (diffY < halfHeight) {
        diffY = halfHeight;
      }

      if (diffY > window.innerHeight - offsetHeight + halfHeight) {
        diffY = window.innerHeight - offsetHeight + halfHeight;
      }

      style2.left = "".concat(diffX, "px");
      style2.top = "".concat(diffY, "px");
    };

    var onDialogMoveEnd = function onDialogMoveEnd() {
      dialog.current.style.cursor = "default";
      document.removeEventListener("mousemove", onDialogMove);
      document.removeEventListener("mouseup", onDialogMoveEnd);
    };

    var onDialogMoveStart = function onDialogMoveStart(e) {
      if (canDraggable) {
        var _dialog$current2 = dialog.current,
            offsetLeft = _dialog$current2.offsetLeft,
            offsetTop = _dialog$current2.offsetTop;
        dialog.current.style.cursor = "move";
        var diffX = e.clientX - offsetLeft;
        var diffY = e.clientY - offsetTop;
        dialogOffset = {
          x: diffX,
          y: diffY
        };
        document.addEventListener("mousemove", onDialogMove);
        document.addEventListener("mouseup", onDialogMoveEnd);
      }
    };

    var dialogElement = /* @__PURE__ */React.createElement("div", {
      ref: dialog,
      style: style,
      className: classNames("".concat(prefixCls), "".concat(prefixCls, "--default"), classNames$1),
      onMouseDown: onDialogMoveStart
    }, closer, header, body, footer);
    return /* @__PURE__ */React.createElement(CSSTransition, {
      "in": props.visible,
      appear: true,
      mountOnEnter: true,
      unmountOnExit: destroyOnClose,
      timeout: transitionTime,
      classNames: "".concat(prefixCls, "-zoom"),
      onEntered: props.onOpened,
      onExited: onAnimateLeave,
      nodeRef: dialog
    }, dialogElement);
  };

  var renderMask = function renderMask() {
    var maskElement;

    if (showOverlay) {
      maskElement = /* @__PURE__ */React.createElement(CSSTransition, {
        "in": visible,
        appear: true,
        timeout: transitionTime,
        classNames: "".concat(prefixCls, "-fade"),
        mountOnEnter: true,
        unmountOnExit: true,
        nodeRef: maskRef
      }, /* @__PURE__ */React.createElement("div", {
        ref: maskRef,
        onClick: onMaskClick,
        className: "".concat(prefixCls, "__mask")
      }));
    }

    return maskElement;
  };

  var render = function render() {
    var style = {};

    if (visible) {
      style.display = "block";
    }

    var wrapStyle = _objectSpread(_objectSpread({}, style), {}, {
      zIndex: zIndex
    });

    var dialogBody = renderDialog("".concat(props.placement ? "".concat(prefixCls, "--").concat(props.placement) : ""));
    var wrapClass = classNames(props.className, "".concat(prefixCls, "__ctx"), "".concat(prefixCls, "__ctx--fixed"), visible ? dialogOpenClass : "");
    var dialog2 = /* @__PURE__ */React.createElement("div", {
      ref: wrap,
      className: wrapClass,
      style: wrapStyle,
      onKeyDown: handleKeyDown,
      tabIndex: 0
    }, mode === "modal" && renderMask(), dialogBody);
    var dom = null;

    if (visible || wrap.current) {
      if (!attach) {
        dom = dialog2;
      } else {
        dom = /* @__PURE__ */React.createElement(CSSTransition, {
          "in": visible,
          appear: true,
          timeout: transitionTime,
          mountOnEnter: true,
          unmountOnExit: destroyOnClose,
          nodeRef: portalRef
        }, /* @__PURE__ */React.createElement(Portal, {
          attach: attach,
          ref: portalRef
        }, dialog2));
      }
    }

    return dom;
  };

  return render();
});
RenderDialog.defaultProps = dialogDefaultProps;

export { RenderDialog as default };
//# sourceMappingURL=RenderDialog.js.map
