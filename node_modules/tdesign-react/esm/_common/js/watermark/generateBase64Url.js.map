{"version":3,"file":"generateBase64Url.js","sources":["../../../../src/_common/js/watermark/generateBase64Url.ts"],"sourcesContent":["import { WatermarkText, WatermarkImage } from './type';\n\nexport default function generateBase64Url({\n  width,\n  height,\n  gapX,\n  gapY,\n  offsetLeft,\n  offsetTop,\n  rotate,\n  alpha,\n  watermarkContent,\n  lineSpace\n}: {\n  width: number,\n  height: number,\n  gapX:number,\n  gapY: number,\n  offsetLeft:number,\n  offsetTop:number,\n  rotate:number,\n  alpha:number,\n  watermarkContent: WatermarkText | WatermarkImage | Array<WatermarkText | WatermarkImage>,\n  lineSpace:number\n}, onFinish: (url: string) => void): string {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  if (!ctx) {\n    // eslint-disable-next-line no-console\n    console.warn('当前环境不支持Canvas, 无法绘制水印');\n    onFinish('');\n    return;\n  }\n  const ratio = window.devicePixelRatio || 1;\n  const canvasWidth = (gapX + width) * ratio;\n  const canvasHeight = (gapY + height) * ratio;\n\n  canvas.width = canvasWidth;\n  canvas.height = canvasHeight;\n  canvas.style.width = `${gapX + width}px`;\n  canvas.style.height = `${gapY + height}px`;\n\n  ctx.translate(offsetLeft * ratio, offsetTop * ratio);\n  ctx.rotate((Math.PI / 180) * Number(rotate));\n  ctx.globalAlpha = alpha;\n\n  const markWidth = width * ratio;\n  const markHeight = height * ratio;\n\n  ctx.fillStyle = 'transparent';\n  ctx.fillRect(0, 0, markWidth, markHeight);\n\n  const contents = Array.isArray(watermarkContent) ? watermarkContent : [{ ...watermarkContent }];\n  let top = 0;\n  contents.forEach((item: WatermarkText & WatermarkImage & { top: number }) => {\n    if (item.url) {\n      const { url, isGrayscale = false } = item;\n      // eslint-disable-next-line no-param-reassign\n      item.top = top;\n      top += height;\n      const img = new Image();\n      img.crossOrigin = 'anonymous';\n      img.referrerPolicy = 'no-referrer';\n      img.src = url;\n      img.onload = () => {\n        // ctx.filter = 'grayscale(1)';\n        ctx.drawImage(img, 0, item.top * ratio, width * ratio, height * ratio);\n        if (isGrayscale) {\n          const imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n          const pixels = imgData.data;\n          for (let i = 0; i < pixels.length; i += 4) {\n            const lightness = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;\n            pixels[i] = lightness;\n            pixels[i + 1] = lightness;\n            pixels[i + 2] = lightness;\n          }\n          ctx.putImageData(imgData, 0, 0);\n        }\n        onFinish(canvas.toDataURL());\n      };\n    } else if (item.text) {\n      const {\n        text,\n        fontColor = 'rgba(0, 0, 0, 0.1)',\n        fontSize = 16,\n        fontWeight = 'normal',\n      } = item;\n      // eslint-disable-next-line no-param-reassign\n      item.top = top;\n      top += lineSpace;\n      const markSize = Number(fontSize) * ratio;\n      // TODO 后续完善font 渲染控制 目前font-family 暂时为 undefiend\n      ctx.font = `normal normal ${fontWeight} ${markSize}px/${markHeight}px undefined`;\n      ctx.textAlign = 'start';\n      ctx.textBaseline = 'top';\n      ctx.fillStyle = fontColor;\n      ctx.fillText(text, 0, item.top * ratio);\n    }\n  });\n  onFinish(canvas.toDataURL());\n}\n"],"names":["generateBase64Url","onFinish","width","height","gapX","gapY","offsetLeft","offsetTop","rotate","alpha","watermarkContent","lineSpace","canvas","document","createElement","ctx","getContext","console","warn","ratio","window","devicePixelRatio","canvasWidth","canvasHeight","style","translate","Math","PI","Number","globalAlpha","markWidth","markHeight","fillStyle","fillRect","contents","Array","isArray","top","forEach","item","url","isGrayscale","img","Image","crossOrigin","referrerPolicy","src","onload","drawImage","imgData","getImageData","pixels","data","i","length","lightness","putImageData","toDataURL","text","fontColor","fontSize","fontWeight","markSize","font","textAlign","textBaseline","fillText"],"mappings":"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"}