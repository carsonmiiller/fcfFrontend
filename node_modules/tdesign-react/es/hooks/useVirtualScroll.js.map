{"version":3,"file":"useVirtualScroll.js","sources":["../../src/hooks/useVirtualScroll.ts"],"sourcesContent":["/* eslint-disable */\nimport { useState, useEffect, useMemo } from 'react';\n\n// 从 Vue 搬代码，原作者 @louiszhai\n// 虚拟滚动Hooks的完整实现，只所以封装成hooks，主要是为了方便跟其他组件搭配使用，比如说表格或者下拉框\nconst useVirtualScroll = ({\n  data,\n  container,\n  fixedHeight = false,\n  lineHeight = 30,\n  bufferSize = 20,\n  threshold = 100,\n}: {\n  data: any;\n  container: HTMLDivElement;\n  fixedHeight: boolean;\n  lineHeight: number;\n  bufferSize: number;\n  threshold: number;\n}) => {\n  const [state] = useState({\n    visibleData: [],\n    cachedHeight: [],\n    cachedScrollY: [],\n  });\n  const isVirtual = useMemo(() => data.value.length > threshold, []);\n  const [updateId, setUpdateId] = useState(0);\n  const trs = new Map(); // 当前展示的行元素和数据\n\n  let visibleCount = 0; // 可见的节点数量\n  let beforeScrollTop = 0; // 上一次的滚动条位置\n  let index = 0; // 偏移行数\n  let offset = 0; // 少于一行行高的偏移量\n  let start = 0; // 第一条显示的行\n  let last = 0; // 最后一条显示的行\n  // let revising = false; // 是否正在修正滚动条\n\n  const reset = () => {\n    data.value.forEach((item: any, i: number) => {\n      // eslint-disable-next-line no-param-reassign\n      item.$index = i;\n      if (fixedHeight) {\n        state.cachedScrollY[i] = i * lineHeight;\n      }\n    });\n    if (!fixedHeight) {\n      state.cachedScrollY[data.value.length - 1] = undefined; // 初始化cachedScrollY数组的长度\n    }\n  };\n  reset();\n\n  // 计算虚拟滚动列表总高度，需要动态修正\n  const scrollHeight = useMemo(() => {\n    const { cachedHeight } = state;\n    const { length } = cachedHeight;\n    if (length) {\n      const maxScrollY = cachedHeight.reduce((sum, v) => sum + v || lineHeight, 0); // 当前总高度\n      if (cachedHeight.length === data.value.length) {\n        return maxScrollY;\n      }\n      const average = maxScrollY / cachedHeight.length; // 平均高度\n      return maxScrollY + (data.value.length - cachedHeight.length) * average; // 预估总高度\n    }\n    return isVirtual ? data.value.length * lineHeight : 0;\n  }, [data.value.length, isVirtual, lineHeight, state]);\n\n  const translateY = useMemo(() => {\n    const { visibleData } = state;\n    const firstRow = visibleData[0];\n    if (firstRow) {\n      // 修复只有一个元素时存在偏移的问题\n      return visibleData.length === 1 ? 0 : state.cachedScrollY[firstRow.$index];\n    }\n    return 0;\n  }, [state]);\n\n  /** 第二种实现，使用watch监听cachedScrollY也可 */\n  // const translateY = ref(0);\n  // watch(() => state.cachedScrollY, () => {\n  //   const { visibleData } = state;\n  //   const firstRow = visibleData[0];\n  //   if (firstRow) {\n  //     // 修复只有一个元素时存在偏移的问题\n  //     translateY.value = visibleData.length === 1 ? 0 : state.cachedScrollY[firstRow.$index];\n  //     return;\n  //   }\n  //   translateY.value = 0;\n  // });\n\n  // 更新可视区域的节点数据\n  const updateVisibleData = () => {\n    last = Math.min(start + visibleCount + bufferSize * 2, data.value.length);\n    state.visibleData = data.value.slice(start, last);\n  };\n\n  // 计算每行对应的scrollTop值\n  const calculateScrollY = () => {\n    const anchorDom = trs.get(index); // 获取锚点元素\n    if (!anchorDom) {\n      return; // 快速调整高度时，新的元素可能来不及加载，暂时跳过更新\n    }\n    const anchorDomHeight = anchorDom.getBoundingClientRect().height; // 获取锚点元素的高\n    state.cachedScrollY[index] = container.scrollTop - offset; // 锚点元素scrollY= 容器滚动高度 - 锚点元素的offset\n    state.cachedHeight[index] = anchorDomHeight;\n\n    for (let i = index + 1; i <= state.visibleData[state.visibleData.length - 1].$index; i++) {\n      // 计算锚点后面的元素scrollY\n      const tr = trs.get(i);\n      const { height } = tr.getBoundingClientRect();\n      state.cachedHeight[i] = height;\n      const scrollY = state.cachedScrollY[i - 1] + state.cachedHeight[i - 1]; // 当前元素的y 是前一个元素的y+前一个元素高度\n      // state.cachedScrollY[i] = scrollY;\n      state.cachedScrollY.splice(i, 1, scrollY); // 兼容vue2的composition api\n    }\n\n    for (let i = index - 1; i >= state.visibleData[0].$index; i--) {\n      const tr = trs.get(i);\n      const { height } = tr.getBoundingClientRect();\n      state.cachedHeight[i] = height;\n      const scrollY = state.cachedScrollY[i + 1] - state.cachedHeight[i]; // 当前元素的y是下一个元素y - 当前元素高度\n      // state.cachedScrollY[i] = scrollY;\n      state.cachedScrollY.splice(i, 1, scrollY);\n    }\n    if (state.cachedScrollY[0] > 0) {\n      // 修正滚动过快时，滚动到顶部时，滚动条多余的问题\n      // revising = true;\n      const distance = state.cachedScrollY[0]; // 第一个元素scrollY即为多出的量\n      const length = Math.min(last, data.value.length);\n      for (let i = 0; i < length; i++) {\n        // state.cachedScrollY[i] -= distance;\n        state.cachedScrollY.splice(i, 1, state.cachedScrollY[i] - distance);\n      }\n\n      const scrollTop = state.cachedScrollY[index - 1] ? state.cachedScrollY[index - 1] + offset : offset;\n      // eslint-disable-next-line no-param-reassign\n      container.scrollTop = scrollTop;\n      beforeScrollTop = scrollTop;\n      // revising = false;\n    }\n    // 修正拖动过快时，滚动到顶端时，滚动条不足的偏差\n    if (state.cachedScrollY[start] < 0) {\n      // revising = true;\n      const s = state.cachedHeight.slice(0, Math.max(0, index)).reduce((sum, v) => sum + v, 0) + offset;\n      // eslint-disable-next-line no-param-reassign\n      container.scrollTop = s;\n      beforeScrollTop = s;\n      if (s === 0) {\n        index = 0;\n        offset = 0;\n      }\n      // revising = false;\n    }\n    const timer = setTimeout(() => {\n      // setTimeout是为了保证快速拖动到底部时，以下逻辑能够正常执行\n      const { scrollTop, scrollHeight: sch, clientHeight } = container;\n      if (scrollTop + clientHeight === sch) {\n        // 滚动到底部时，修正底部有空余的问题\n        // revising = true;\n        for (let i = last - 1; i >= start; i--) {\n          if (i === last - 1) {\n            // state.cachedScrollY[i] = scrollHeight.value - state.cachedHeight[i];\n            state.cachedScrollY.splice(i, 1, scrollHeight - state.cachedHeight[i]);\n          } else {\n            // state.cachedScrollY[i] = state.cachedScrollY[i + 1] - state.cachedHeight[i];\n            state.cachedScrollY.splice(i, 1, state.cachedScrollY[i + 1] - state.cachedHeight[i]);\n          }\n        }\n        // revising = false;\n      }\n      clearTimeout(timer);\n    }, 0);\n  };\n\n  // 滚动时动态计算和渲染\n  const handleScroll = () => {\n    if (!isVirtual) return;\n    // if (revising) {\n    //   return false; // 修正滚动条时，暂停滚动逻辑\n    // }\n    const { scrollTop } = container;\n    let distance = scrollTop - beforeScrollTop; // 滚动差值\n    beforeScrollTop = scrollTop;\n    distance += offset;\n    let lastIndex = index;\n    // !disatance 可能为横向滚动，不做任何计算\n    if (!distance) return;\n    if (distance >= 0) {\n      // 向下滚动\n      while (lastIndex < data.value.length && distance > (state.cachedHeight[lastIndex] || lineHeight)) {\n        if (!state.cachedHeight[lastIndex]) {\n          state.cachedHeight[lastIndex] = lineHeight;\n        }\n        distance -= state.cachedHeight[lastIndex];\n        // eslint-disable-next-line no-plusplus\n        lastIndex++;\n      }\n      if (lastIndex >= data.value.length) {\n        index = data.value.length - 1;\n        offset = 0;\n      } else {\n        index = lastIndex;\n        offset = distance;\n      }\n      const { clientHeight, scrollHeight } = container;\n      if (scrollTop + clientHeight === scrollHeight) {\n        // 滚动条到底了\n        index = data.value.length - visibleCount + 1;\n        // calculateScrollY();\n      }\n      if (start <= index - bufferSize) {\n        // 计算第一个挂载元素\n        start = Math.min(data.value.length - visibleCount, index - bufferSize);\n        if (start < 0) {\n          start = 0;\n        }\n      }\n    } else {\n      // 向上滚动\n      while (distance < 0) {\n        // eslint-disable-next-line no-plusplus\n        lastIndex--;\n        if (!state.cachedHeight[lastIndex]) {\n          state.cachedHeight[lastIndex] = lineHeight;\n        }\n        distance += state.cachedHeight[lastIndex];\n      }\n      if (lastIndex < 0) {\n        index = 0;\n        offset = 0;\n      } else {\n        index = lastIndex;\n        offset = distance;\n      }\n      calculateScrollY();\n      if (start > index - bufferSize) {\n        // 计算第一个挂载元素\n        start = Math.max(0, index - bufferSize);\n      }\n    }\n    updateVisibleData();\n  };\n\n  useEffect(() => {\n    !fixedHeight && calculateScrollY();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [fixedHeight]);\n\n  const handleRowMounted = () => {\n    if (!isVirtual) return;\n    setUpdateId(updateId);\n  };\n\n  useEffect(() => {\n    reset();\n    state.visibleData = [];\n    state.cachedScrollY = [];\n    state.cachedHeight = [];\n    beforeScrollTop = 0;\n    index = 0;\n    offset = 0;\n    start = 0;\n    // revising = false;\n    trs.clear();\n    if (data.value.length <= threshold) {\n      state.visibleData = data.value;\n    } else {\n      updateVisibleData();\n    }\n    // eslint-disable-next-line no-param-reassign\n    container && (container.scrollTop = 0);\n  }, [data]);\n\n  let mounted = false;\n  const refreshContainer = () => {\n    if (mounted) {\n      visibleCount = Math.ceil(container.offsetHeight / lineHeight);\n      updateVisibleData();\n    }\n  };\n  useEffect(() => {\n    if (!window || !window.IntersectionObserver) {\n      return;\n    }\n    const ob = new window.IntersectionObserver((entries) => {\n      const entry = entries[0];\n      if (entry.isIntersecting || entry.intersectionRatio) {\n        mounted = true;\n        isVirtual && refreshContainer();\n        ob.unobserve(container);\n      }\n    });\n    container && ob.observe(container);\n  }, []);\n  return {\n    trs,\n    scrollHeight,\n    ...state,\n    translateY,\n    handleScroll,\n    handleRowMounted,\n    refreshContainer,\n    fixedHeight,\n    calculateScrollY,\n  };\n};\nexport default useVirtualScroll;\n"],"names":["useVirtualScroll","data","container","fixedHeight","lineHeight","bufferSize","threshold","useState","visibleData","cachedHeight","cachedScrollY","state","isVirtual","useMemo","value","length","updateId","setUpdateId","trs","Map","visibleCount","beforeScrollTop","index","offset","start","last","reset","forEach","item","i","$index","scrollHeight","maxScrollY","reduce","sum","v","average","translateY","firstRow","updateVisibleData","Math","min","slice","calculateScrollY","anchorDom","get","anchorDomHeight","getBoundingClientRect","height","scrollTop","tr","scrollY","splice","distance","s","max","timer","setTimeout","sch","clientHeight","clearTimeout","handleScroll","lastIndex","scrollHeight2","useEffect","handleRowMounted","clear","mounted","refreshContainer","ceil","offsetHeight","window","IntersectionObserver","ob","entries","entry","isIntersecting","intersectionRatio","unobserve","observe"],"mappings":"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"}