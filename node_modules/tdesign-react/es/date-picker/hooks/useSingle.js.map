{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { CalendarIcon } from 'tdesign-icons-react';\nimport dayjs from 'dayjs';\nimport classNames from 'classnames';\nimport useConfig from '../../_util/useConfig';\nimport useControlled from '../../hooks/useControlled';\nimport { TdDatePickerProps, DateValue } from '../type';\nimport useFormat from './useFormat';\n\nexport default function useSingle(props: TdDatePickerProps) {\n  const { classPrefix, datePicker: globalDatePickerConfig } = useConfig();\n  const name = `${classPrefix}-date-picker`;\n\n  const inputRef = useRef<HTMLInputElement>();\n\n  const {\n    mode,\n    prefixIcon,\n    suffixIcon,\n    inputProps: inputPropsFromProps,\n    popupProps: popupPropsFromProps,\n    allowInput,\n    clearable,\n    placeholder = globalDatePickerConfig.placeholder[mode],\n    onBlur,\n    onFocus,\n    onInput,\n  } = props;\n\n  const [value, onChange] = useControlled(props, 'value', props.onChange);\n  const { isValidDate, formatDate, formatTime } = useFormat({\n    value,\n    mode,\n    format: props.format,\n    valueType: props.valueType,\n    enableTimePicker: props.enableTimePicker,\n  });\n\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [isHoverCell, setIsHoverCell] = useState(false);\n  const [timeValue, setTimeValue] = useState(formatTime(value));\n  const [month, setMonth] = useState<number>(dayjs(value).month() || new Date().getMonth());\n  const [year, setYear] = useState<number>(dayjs(value).year() || new Date().getFullYear());\n  // 未真正选中前可能不断变更输入框的内容\n  const [inputValue, setInputValue] = useState(formatDate(value));\n  const [cacheValue, setCacheValue] = useState(formatDate(value)); // 缓存选中值，panel 点击时更改\n\n  // input 设置\n  const inputProps = {\n    ...inputPropsFromProps,\n    ref: inputRef,\n    clearable,\n    prefixIcon,\n    readonly: !allowInput,\n    placeholder,\n    suffixIcon: suffixIcon || <CalendarIcon />,\n    className: classNames({\n      [`${name}__input--placeholder`]: isHoverCell,\n    }),\n    onClear: ({ e }) => {\n      e.stopPropagation();\n      setPopupVisible(false);\n      onChange('', { dayjsValue: dayjs(''), trigger: 'clear' });\n    },\n    onBlur: (val: string, { e }) => {\n      onBlur?.({ value: val, e });\n    },\n    onFocus: (_: string, { e }) => {\n      onFocus?.({ value, e });\n    },\n    onChange: (val: string, { e }) => {\n      onInput?.({ input: val, value, e });\n\n      // 输入事件\n      setInputValue(val);\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val);\n      !Number.isNaN(newYear) && setYear(newYear);\n      !Number.isNaN(newMonth) && setMonth(newMonth);\n      !Number.isNaN(newTime) && setTimeValue(newTime);\n    },\n    onEnter: (val: string) => {\n      if (!isValidDate(val) && !isValidDate(value)) return;\n\n      setPopupVisible(false);\n      if (isValidDate(val)) {\n        onChange(formatDate(val, 'valueType') as DateValue, { dayjsValue: dayjs(val), trigger: 'enter' });\n      } else if (isValidDate(value)) {\n        setInputValue(formatDate(value));\n      } else {\n        setInputValue('');\n      }\n    },\n  };\n\n  // popup 设置\n  const popupProps = {\n    expandAnimation: true,\n    ...popupPropsFromProps,\n    overlayStyle: popupPropsFromProps?.overlayStyle ?? { width: 'auto' },\n    overlayClassName: classNames(popupPropsFromProps?.overlayClassName, `${name}__panel-container`),\n    onVisibleChange: (visible: boolean) => {\n      setPopupVisible(visible);\n      if (!visible) {\n        setIsHoverCell(false);\n        setInputValue(formatDate(value));\n      }\n    },\n  };\n\n  // 输入框响应 value 变化\n  useEffect(() => {\n    if (!value) {\n      setInputValue('');\n      setCacheValue('');\n      setTimeValue(formatTime(new Date()));\n      return;\n    }\n    if (!isValidDate(value, 'valueType')) return;\n\n    setInputValue(formatDate(value));\n    setCacheValue(formatDate(value));\n    setTimeValue(formatTime(value));\n    // eslint-disable-next-line\n  }, [value]);\n\n  return {\n    year,\n    month,\n    value,\n    timeValue,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    onChange,\n    setYear,\n    setMonth,\n    setTimeValue,\n    setIsHoverCell,\n    setInputValue,\n    setPopupVisible,\n    setCacheValue,\n  };\n}\n"],"names":["useSingle","props","useConfig","classPrefix","globalDatePickerConfig","datePicker","name","inputRef","useRef","mode","prefixIcon","suffixIcon","inputPropsFromProps","inputProps","popupPropsFromProps","popupProps","allowInput","clearable","placeholder","onBlur","onFocus","onInput","useControlled","onChange","value","useFormat","format","valueType","enableTimePicker","isValidDate","formatDate","formatTime","useState","popupVisible","setPopupVisible","isHoverCell","setIsHoverCell","timeValue","setTimeValue","dayjs","month","Date","getMonth","setMonth","year","getFullYear","setYear","inputValue","setInputValue","cacheValue","setCacheValue","ref","readonly","React","createElement","CalendarIcon","className","classNames","onClear","e","stopPropagation","dayjsValue","trigger","val","_","input","newMonth","newYear","newTime","Number","isNaN","onEnter","expandAnimation","overlayStyle","width","overlayClassName","onVisibleChange","visible","useEffect"],"mappings":"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"}