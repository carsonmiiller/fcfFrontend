{"version":3,"file":"Affix.js","sources":["../../src/affix/Affix.tsx"],"sourcesContent":["import React, { useEffect, forwardRef, useCallback, useImperativeHandle, useRef } from 'react';\nimport isFunction from 'lodash/isFunction';\nimport { StyledProps, ScrollContainerElement } from '../common';\nimport { TdAffixProps } from './type';\nimport { getScrollContainer } from '../_util/dom';\nimport useConfig from '../_util/useConfig';\nimport { affixDefaultProps } from './defaultProps';\n\nexport interface AffixProps extends TdAffixProps, StyledProps {\n  children: React.ReactNode;\n}\n\nexport interface AffixRef {\n  handleScroll: () => void;\n}\n\nconst Affix = forwardRef<AffixRef, AffixProps>((props, ref) => {\n  const { children, zIndex, container, offsetBottom, offsetTop, onFixedChange } = props;\n\n  const { classPrefix } = useConfig();\n\n  const affixRef = useRef<HTMLDivElement>(null);\n  const affixWrapRef = useRef<HTMLDivElement>(null);\n  const placeholderEL = useRef<HTMLElement>(null);\n  const scrollContainer = useRef<ScrollContainerElement>(null);\n\n  const ticking = useRef(false);\n\n  // 这里是通过控制 wrap 的 border-top 到浏览器顶部距离和 offsetTop 比较\n  const handleScroll = useCallback(() => {\n    if (!ticking.current) {\n      window.requestAnimationFrame(() => {\n        // top = 节点到页面顶部的距离，包含 scroll 中的高度\n        const {\n          top: wrapToTop = 0,\n          width: wrapWidth = 0,\n          height: wrapHeight = 0,\n        } = affixWrapRef.current?.getBoundingClientRect() ?? { top: 0 };\n\n        // 容器到页面顶部的距离, windows 为0\n        let containerToTop = 0;\n        if (scrollContainer.current instanceof HTMLElement) {\n          containerToTop = scrollContainer.current.getBoundingClientRect().top;\n        }\n\n        const calcTop = wrapToTop - containerToTop; // 节点顶部到 container 顶部的距离\n        const containerHeight =\n          scrollContainer.current[scrollContainer.current instanceof Window ? 'innerHeight' : 'clientHeight'] -\n          wrapHeight;\n        const calcBottom = containerToTop + containerHeight - (offsetBottom ?? 0); // 计算 bottom 相对应的 top 值\n\n        let fixedTop: number | false;\n        if (offsetTop !== undefined && calcTop <= offsetTop) {\n          // top 的触发\n          fixedTop = containerToTop + offsetTop;\n        } else if (offsetBottom !== undefined && wrapToTop >= calcBottom) {\n          // bottom 的触发\n          fixedTop = calcBottom;\n        } else {\n          fixedTop = false;\n        }\n\n        if (affixRef.current) {\n          const affixed = fixedTop !== false;\n          const placeholderStatus = affixWrapRef.current.contains(placeholderEL.current);\n\n          if (affixed) {\n            // 定位\n            affixRef.current.className = `${classPrefix}-affix`;\n            affixRef.current.style.top = `${fixedTop}px`;\n            affixRef.current.style.width = `${wrapWidth}px`;\n            affixRef.current.style.height = `${wrapHeight}px`;\n\n            if (zIndex) {\n              affixRef.current.style.zIndex = `${zIndex}`;\n            }\n\n            // 插入占位节点\n            if (!placeholderStatus) {\n              placeholderEL.current.style.width = `${wrapWidth}px`;\n              placeholderEL.current.style.height = `${wrapHeight}px`;\n              affixWrapRef.current.appendChild(placeholderEL.current);\n            }\n          } else {\n            affixRef.current.removeAttribute('class');\n            affixRef.current.removeAttribute('style');\n\n            // 删除占位节点\n            placeholderStatus && placeholderEL.current.remove();\n          }\n\n          if (isFunction(onFixedChange)) {\n            onFixedChange(affixed, { top: +fixedTop });\n          }\n        }\n\n        ticking.current = false;\n      });\n    }\n    ticking.current = true;\n  }, [classPrefix, offsetBottom, offsetTop, onFixedChange, zIndex]);\n\n  useImperativeHandle(ref, () => ({\n    handleScroll,\n  }));\n\n  useEffect(() => {\n    // 创建占位节点\n    placeholderEL.current = document.createElement('div');\n  }, []);\n\n  useEffect(() => {\n    scrollContainer.current = getScrollContainer(container);\n    if (scrollContainer.current) {\n      handleScroll();\n      scrollContainer.current.addEventListener('scroll', handleScroll);\n      window.addEventListener('resize', handleScroll);\n\n      return () => {\n        scrollContainer.current.removeEventListener('scroll', handleScroll);\n        window.removeEventListener('resize', handleScroll);\n      };\n    }\n  }, [container, handleScroll]);\n\n  return (\n    <div ref={affixWrapRef}>\n      <div ref={affixRef}>{children}</div>\n    </div>\n  );\n});\n\nAffix.displayName = 'Affix';\nAffix.defaultProps = affixDefaultProps;\n\nexport default Affix;\n"],"names":["Affix","forwardRef","props","ref","children","zIndex","container","offsetBottom","offsetTop","onFixedChange","useConfig","classPrefix","affixRef","useRef","affixWrapRef","placeholderEL","scrollContainer","ticking","handleScroll","useCallback","current","window","requestAnimationFrame","getBoundingClientRect","top","wrapToTop","width","wrapWidth","height","wrapHeight","containerToTop","HTMLElement","calcTop","containerHeight","Window","calcBottom","fixedTop","affixed","placeholderStatus","contains","className","style","appendChild","removeAttribute","remove","isFunction","useImperativeHandle","useEffect","document","createElement","getScrollContainer","addEventListener","removeEventListener","React","displayName","defaultProps","affixDefaultProps"],"mappings":"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"}