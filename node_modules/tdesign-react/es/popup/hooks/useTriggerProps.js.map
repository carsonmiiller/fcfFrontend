{"version":3,"file":"useTriggerProps.js","sources":["../../../src/popup/hooks/useTriggerProps.ts"],"sourcesContent":["import React, { HTMLAttributes, MutableRefObject, useRef } from 'react';\nimport useClickOutside from '../../_util/useClickOutside';\nimport { TdPopupProps, PopupVisibleChangeContext, PopupTriggerEvent } from '../type';\nimport { ChangeHandler } from '../../hooks/useControlled';\n\nexport type TriggerProps = HTMLAttributes<HTMLDivElement>;\nexport type PopupProps = HTMLAttributes<HTMLDivElement>;\ntype HandleTrigger = (e: PopupTriggerEvent, trigger: PopupVisibleChangeContext['trigger']) => void;\nconst ESC_KEY = 'Escape';\n\nexport default function useTriggerProps(\n  ref: MutableRefObject<HTMLElement>,\n  triggerNode: MutableRefObject<HTMLElement>,\n  triggers: Array<TdPopupProps['trigger']>,\n  visible: boolean,\n  setVisible: ChangeHandler<boolean, [PopupVisibleChangeContext]>,\n  disabled = false,\n  originTrigger: React.ReactElement<HTMLAttributes<HTMLElement>>,\n): [TriggerProps, PopupProps] {\n  const triggerProps: TriggerProps = {};\n  const popupProps: PopupProps = {};\n  const hasPopupMouseDown = useRef(false);\n  const mouseDownTimer = useRef<number>();\n  const toggle: HandleTrigger = (e, trigger) => setVisible(!visible, { e, trigger });\n  const show: HandleTrigger = (e, trigger) => setVisible(true, { e, trigger });\n  const hide: HandleTrigger = (e, trigger) => setVisible(false, { e, trigger });\n\n  // click outside 用于处理点击其他地方隐藏\n  useClickOutside([ref, triggerNode], (e: any) => {\n    if (visible && (triggers.includes('click') || triggers.includes('context-menu')) && !hasPopupMouseDown.current) {\n      hide(e, 'trigger-element-blur');\n    }\n  });\n\n  if (disabled) return [triggerProps, popupProps];\n\n  // eslint-disable-next-line no-restricted-syntax\n  for (const trigger of triggers) {\n    const { onClick, onMouseEnter, onMouseLeave, onMouseDown, onFocus, onBlur, onContextMenu, onKeyDown } =\n      originTrigger.props;\n    // 点击触发\n    if (trigger === 'click') {\n      triggerProps.onClick = (e) => {\n        toggle(e, 'trigger-element-click');\n        onClick && onClick(e);\n      };\n    }\n\n    // hover 触发\n    if (trigger === 'hover') {\n      triggerProps.onMouseEnter = (e) => {\n        show(e, 'trigger-element-hover');\n        onMouseEnter && onMouseEnter(e);\n      };\n      popupProps.onMouseEnter = (e) => {\n        // 如果当前弹出框本身没有展示 hover时不应该展示\n        visible && show(e, 'trigger-element-hover');\n      }; // 兼容鼠标移入弹出框\n      triggerProps.onMouseLeave = (e) => {\n        hide(e, 'trigger-element-hover');\n        onMouseLeave && onMouseLeave(e);\n      };\n      popupProps.onMouseLeave = (e) => hide(e, 'trigger-element-hover');\n    }\n\n    // focus 触发\n    if (trigger === 'focus') {\n      triggerProps.onFocus = (e) => {\n        show(e, 'trigger-element-focus');\n        onFocus && onFocus(e);\n      };\n      triggerProps.onBlur = (e) => {\n        hide(e, 'trigger-element-blur');\n        onBlur && onBlur(e);\n      };\n    }\n\n    // contextMenu 触发\n    if (trigger === 'context-menu') {\n      triggerProps.onContextMenu = (e) => {\n        show(e, 'context-menu');\n        onContextMenu && onContextMenu(e);\n      };\n    }\n\n    popupProps.onMouseDown = (e) => {\n      clearTimeout(mouseDownTimer.current);\n      hasPopupMouseDown.current = true;\n      mouseDownTimer.current = window.setTimeout(() => {\n        hasPopupMouseDown.current = false;\n      });\n      onMouseDown?.(e);\n    };\n\n    triggerProps.onKeyDown = (e) => {\n      if (e.key === ESC_KEY) hide(e, 'keydown-esc');\n      onKeyDown && onKeyDown(e);\n    };\n  }\n\n  return [triggerProps, popupProps];\n}\n"],"names":["ESC_KEY","useTriggerProps","ref","triggerNode","triggers","visible","setVisible","disabled","originTrigger","triggerProps","popupProps","hasPopupMouseDown","useRef","mouseDownTimer","toggle","e","trigger","show","hide","useClickOutside","includes","current","props","onClick","onMouseEnter","onMouseLeave","onMouseDown","onFocus","onBlur","onContextMenu","onKeyDown","clearTimeout","window","setTimeout","key"],"mappings":"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"}